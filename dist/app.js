!function(e){var t={};function o(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)o.d(r,s,function(t){return e[t]}.bind(null,s));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=5)}([function(e,t,o){"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.LayerId=t.Action=t.SoundAsset=t.FORKJOIN_PLAYER_MAPPING=t.PLAYER_FORK_MAPPING=t.PLAYER_JOIN_MAPPING=t.ImageAsset=void 0,function(e){e.placeholder="placeholder.png",e.player_u="player_u.png",e.player_d="player_d.png",e.player_l="player_l.png",e.player_r="player_r.png",e.fork_u="fork_u.png",e.fork_d="fork_d.png",e.fork_l="fork_l.png",e.fork_r="fork_r.png",e.join_u="join_u.png",e.join_d="join_d.png",e.join_l="join_l.png",e.join_r="join_r.png",e.crack_1="crack_1.png",e.crack_2="crack_2.png",e.crack_3="crack_3.png",e.crate_wood="crate_wood.png",e.crate_metal="crate_metal.png",e.target_wood_1="target_wood_1.png",e.target_wood_2="target_wood_2.png",e.target_metal_1="target_metal_1.png",e.target_metal_2="target_metal_2.png",e.target_player_1="target_player_1.png",e.target_player_2="target_player_2.png",e.wall="wall.png",e.bg1="bg1.png",e.bg2="bg2.png",e.bg3="bg3.png",e.bg4="bg4.png"}(r=t.ImageAsset||(t.ImageAsset={})),t.PLAYER_JOIN_MAPPING=new Map([[r.fork_u,r.join_u],[r.fork_d,r.join_d],[r.fork_l,r.join_l],[r.fork_r,r.join_r],[r.join_u,r.join_u],[r.join_d,r.join_d],[r.join_l,r.join_l],[r.join_r,r.join_r],[r.player_u,r.join_u],[r.player_d,r.join_d],[r.player_l,r.join_l],[r.player_r,r.join_r]]),t.PLAYER_FORK_MAPPING=new Map([[r.fork_u,r.fork_u],[r.fork_d,r.fork_d],[r.fork_l,r.fork_l],[r.fork_r,r.fork_r],[r.join_u,r.fork_u],[r.join_d,r.fork_d],[r.join_l,r.fork_l],[r.join_r,r.fork_r],[r.player_u,r.fork_u],[r.player_d,r.fork_d],[r.player_l,r.fork_l],[r.player_r,r.fork_r]]),t.FORKJOIN_PLAYER_MAPPING=new Map([[r.fork_u,r.player_u],[r.fork_d,r.player_d],[r.fork_l,r.player_l],[r.fork_r,r.player_r],[r.join_u,r.player_u],[r.join_d,r.player_d],[r.join_l,r.player_l],[r.join_r,r.player_r],[r.player_u,r.player_u],[r.player_d,r.player_d],[r.player_l,r.player_l],[r.player_r,r.player_r]]),function(e){e.fork="fork.wav",e.join="join.wav",e.done="done.wav",e.move="move.wav"}(t.SoundAsset||(t.SoundAsset={})),function(e){e[e.up=1]="up",e[e.down=2]="down",e[e.left=3]="left",e[e.right=4]="right",e[e.idle=5]="idle",e[e.undo=6]="undo",e[e.redo=7]="redo",e[e.fork=10]="fork",e[e.join=11]="join",e[e.restart=20]="restart"}(t.Action||(t.Action={})),function(e){e[e.bg=1]="bg",e[e.crack=2]="crack",e[e.crate=3]="crate",e[e.target=4]="target",e[e.fork=5]="fork",e[e.player=6]="player",e[e.wall=7]="wall"}(t.LayerId||(t.LayerId={}))},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.H=t.W=t.TILE_SIZE=void 0,t.TILE_SIZE=64,t.W=9,t.H=9},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageAssets=void 0;const r=o(0);class s{static init(){let e=Object.values(r.ImageAsset);return Promise.all(e.map(e=>(console.log("loaded image",e),new Promise(t=>{let o=new Image;o.src="assets/"+e,s.images.set(e,o),o.onload=()=>{t()},o.onerror=()=>{console.log("image onerror, use fallback: ",e),o.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z/C/HgAGgwJ/lK3Q6wAAAABJRU5ErkJggg=="}}))))}static get(e){return s.images.get(e.valueOf())}}t.ImageAssets=s,s.images=new Map},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.startLevel=t.ALL_CELL_TYPES=t.CELL_LAYER_MAPPING=t.CELL_IMAGE_MAPPING=t.o=t.w=t.c=t.Z=t.Y=t.X=t.V=t.U=t.P=t.levels=void 0;const r=o(0);t.levels=[],t.P=1,t.U=2,t.V=3,t.X=4,t.Y=5,t.Z=6,t.c=7,t.w=8,t.o=9,t.CELL_IMAGE_MAPPING=[],t.CELL_IMAGE_MAPPING[t.P]=r.ImageAsset.player_d,t.CELL_IMAGE_MAPPING[t.U]=r.ImageAsset.crate_wood,t.CELL_IMAGE_MAPPING[t.V]=r.ImageAsset.crate_metal,t.CELL_IMAGE_MAPPING[t.X]=r.ImageAsset.target_wood_1,t.CELL_IMAGE_MAPPING[t.Y]=r.ImageAsset.target_metal_1,t.CELL_IMAGE_MAPPING[t.Z]=r.ImageAsset.target_player_1,t.CELL_IMAGE_MAPPING[t.c]=r.ImageAsset.crack_1,t.CELL_IMAGE_MAPPING[t.w]=r.ImageAsset.wall,t.CELL_LAYER_MAPPING=[],t.CELL_LAYER_MAPPING[t.P]=r.LayerId.player,t.CELL_LAYER_MAPPING[t.U]=r.LayerId.crate,t.CELL_LAYER_MAPPING[t.V]=r.LayerId.crate,t.CELL_LAYER_MAPPING[t.X]=r.LayerId.target,t.CELL_LAYER_MAPPING[t.Y]=r.LayerId.target,t.CELL_LAYER_MAPPING[t.Z]=r.LayerId.target,t.CELL_LAYER_MAPPING[t.c]=r.LayerId.crack,t.CELL_LAYER_MAPPING[t.w]=r.LayerId.wall,t.ALL_CELL_TYPES=[t.P,t.U,t.V,t.X,t.Y,t.o,t.w],function(){let e=window;e.P=t.P,e.U=t.U,e.V=t.V,e.X=t.X,e.Y=t.Y,e.Z=t.Z,e.c=t.c,e.w=t.w,e.o=t.o}(),t.levels[0]={name:"Sokoban",maxtime:20,goldtime:13,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.X,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.U,t.w,t.w,t.w,t.w,t.P,t.o,t.o,t.o,t.o,t.o,t.o,t.o,t.Z,t.w,t.w,t.w,t.w,t.V,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.Y,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.levels[1]={name:"Wood and Metal",maxtime:30,goldtime:17,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.o,t.o,t.o,t.o,t.o,t.o,t.w,t.w,t.o,t.o,t.o,t.o,t.o,t.o,t.o,t.w,t.w,t.o,t.o,t.U,t.o,t.Y,t.o,t.o,t.w,t.P,t.c,t.o,t.o,t.o,t.o,t.o,t.c,t.Z,t.w,t.o,t.o,t.V,t.o,t.X,t.o,t.o,t.w,t.w,t.o,t.o,t.o,t.o,t.o,t.o,t.o,t.w,t.w,t.o,t.o,t.o,t.o,t.o,t.o,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.levels[2]={name:"K to Fork<br>Then<br>J to Join",maxtime:30,goldtime:15,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.o,t.o,t.o,t.U,t.o,t.X,t.w,t.w,t.c,t.w,t.w,t.w,t.o,t.w,t.w,t.w,t.P,t.o,t.w,t.w,t.w,t.o,t.o,t.o,t.Z,t.w,t.c,t.w,t.w,t.w,t.o,t.w,t.w,t.w,t.w,t.o,t.o,t.o,t.o,t.V,t.o,t.Y,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.levels[3]={name:"Help each other",maxtime:30,goldtime:17,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.o,t.o,t.c,t.o,t.o,t.o,t.w,t.w,t.o,t.w,t.w,t.U,t.w,t.w,t.w,t.w,t.P,t.o,t.w,t.w,t.o,t.w,t.o,t.o,t.Z,t.w,t.o,t.w,t.w,t.o,t.w,t.o,t.o,t.w,t.w,t.o,t.o,t.o,t.o,t.o,t.o,t.X,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.levels[4]={name:"Insider",maxtime:50,goldtime:32,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.w,t.w,t.w,t.o,t.o,t.w,t.w,t.w,t.o,t.U,t.o,t.o,t.o,t.o,t.o,t.w,t.P,t.o,t.U,t.w,t.X,t.X,t.w,t.o,t.Z,t.w,t.o,t.o,t.o,t.o,t.w,t.w,t.o,t.w,t.w,t.o,t.o,t.o,t.o,t.w,t.w,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.levels[5]={name:"Corner",maxtime:150,goldtime:90,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.w,t.w,t.w,t.o,t.o,t.o,t.w,t.w,t.o,t.V,t.o,t.o,t.o,t.o,t.o,t.w,t.P,t.o,t.U,t.w,t.Y,t.X,t.w,t.o,t.Z,t.w,t.o,t.o,t.o,t.o,t.w,t.w,t.o,t.w,t.w,t.o,t.o,t.o,t.o,t.w,t.w,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.levels[6]={name:"Corners",maxtime:200,goldtime:110,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.U,t.o,t.o,t.o,t.U,t.o,t.w,t.w,t.o,t.o,t.X,t.o,t.X,t.w,t.o,t.w,t.P,t.o,t.o,t.o,t.o,t.o,t.o,t.o,t.Z,t.w,t.o,t.o,t.X,t.o,t.X,t.o,t.o,t.w,t.w,t.w,t.U,t.c,t.w,t.o,t.U,t.o,t.w,t.w,t.w,t.o,t.o,t.w,t.w,t.w,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.levels[7]={name:"Kill-stealing",maxtime:200,goldtime:120,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.o,t.o,t.w,t.w,t.w,t.o,t.w,t.w,t.o,t.U,t.U,t.X,t.X,t.w,t.o,t.w,t.w,t.P,t.U,t.o,t.X,t.X,t.V,t.o,t.w,t.w,t.o,t.o,t.w,t.U,t.Y,t.o,t.o,t.Z,t.w,t.o,t.o,t.o,t.o,t.w,t.o,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.levels[8]={name:"Teamwork<br>80 turns",maxtime:80,goldtime:65,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.o,t.o,t.w,t.o,t.o,t.o,t.w,t.w,t.P,t.X,t.X,t.o,t.U,t.U,t.o,t.w,t.w,t.o,t.X,t.V,t.o,t.U,t.Y,t.o,t.w,t.w,t.o,t.V,t.V,t.o,t.Y,t.Y,t.o,t.Z,t.w,t.o,t.o,t.o,t.w,t.o,t.o,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.levels[9]={name:"Corridor",maxtime:300,goldtime:220,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.o,t.w,t.o,t.o,t.o,t.o,t.w,t.w,t.o,t.w,t.w,t.o,t.V,t.X,t.o,t.w,t.w,t.o,t.o,t.w,t.o,t.V,t.X,t.o,t.w,t.P,t.o,t.Y,t.U,t.o,t.V,t.X,t.o,t.Z,t.w,t.o,t.Y,t.U,t.o,t.w,t.o,t.o,t.w,t.w,t.o,t.Y,t.U,t.o,t.w,t.o,t.w,t.w,t.w,t.o,t.o,t.o,t.o,t.w,t.o,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.startLevel=0},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SoundAssets=void 0;const r=o(0);class s{static init(){window.play1=()=>s.play(r.SoundAsset.done),window.play2=()=>s.play(r.SoundAsset.fork),window.play3=()=>s.play(r.SoundAsset.join);let e=Object.values(r.SoundAsset);return Promise.all(e.map(e=>(console.log("loaded sound",e),new Promise(t=>{let o=new XMLHttpRequest;o.open("GET","assets/"+e,!0),o.responseType="arraybuffer",o.onload=function(){s.context.decodeAudioData(o.response).then(o=>{s.sounds.set(e,o),t()}).catch(()=>{t()})},o.send()}))))}static play(e){console.log(e);let t=s.sounds.get(e.valueOf());if(t){let e=s.context.createBufferSource();e.buffer=t,e.connect(s.context.destination),e.start()}}}t.SoundAssets=s,s.context=new AudioContext,s.sounds=new Map},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=o(2),s=o(6),a=o(1),i=o(0),l=o(4);let n=document.getElementById("container"),w=document.getElementById("canvas"),c=w.getContext("2d"),d=document.getElementsByClassName("hint"),h=a.TILE_SIZE*a.W,u=a.TILE_SIZE*a.H;w.width=h,w.height=u,w.style.width=h+"px",w.style.height=u+"px";for(let e of d){let t=e;t.style.width=h+"px",t.style.height=u+"px"}n.style.width=h+150+"px",n.style.height=u+"px",c.clearRect(0,0,h,u),c.strokeStyle="gray",c.strokeRect(0,0,h,u),async function(){await r.ImageAssets.init(),await l.SoundAssets.init(),document.getElementById("loading").style.display="none";let e=new s.Game(w,c);window.onkeypress=t=>{let o=null;switch(t.key){case"w":o=i.Action.up;break;case"a":o=i.Action.left;break;case"s":o=i.Action.down;break;case"d":o=i.Action.right;break;case" ":o=i.Action.idle;break;case"j":o=i.Action.join;break;case"k":o=i.Action.fork;break;case"z":o=i.Action.undo;break;case"x":o=i.Action.redo;break;case"r":o=i.Action.restart}o&&e.update(o)}}()},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Game=void 0;const r=o(7),s=o(1),a=o(10),i=o(0),l=o(3);t.Game=class{constructor(e,t){this.canvas=e,this.context=t,this.map=new r.GameMap(e,t),this.init(),window.loadlevel=e=>{l.levels[0]=e,this.gamelogic.load(0)},this.gamelogic=new a.Gamelogic(this.map),this.gamelogic.load(l.startLevel)}init(){this.map.visitLayer(i.LayerId.bg,e=>{for(let t=0;t<s.W;t++)for(let o=0;o<s.H;o++){let r=Math.floor(4*Math.random())+1,s=i.ImageAsset.placeholder;switch(r){case 1:s=i.ImageAsset.bg1;break;case 2:s=i.ImageAsset.bg2;break;case 3:s=i.ImageAsset.bg3;break;case 4:s=i.ImageAsset.bg4}e.createSprite(t,o,s)}});let e="";for(let t=0;t<l.levels.length;t++)e+=`<button id="load${t}" style="font-size: 16px;">${t}</button>\n`;document.getElementById("levels").innerHTML=e;for(let e=0;e<l.levels.length;e++){let t=document.getElementById("load"+e);t.onclick=()=>{this.gamelogic.load(e),t.blur()}}}update(e){if(this.gamelogic.update(e),this.gamelogic.check()){console.log("levelDone");let e=this.gamelogic.hasNextLevel();e>0?setTimeout(()=>{this.gamelogic.load(e)},500):(console.log("all done!"),document.getElementById("alldone").style.display="block")}}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameMap=void 0;const r=o(8),s=o(0),a=o(1);t.GameMap=class{constructor(e,t){this.canvas=e,this.context=t;let o=Object.values(s.LayerId);this.layers=[];for(let e of o)"number"==typeof e&&(this.layers[e]=new r.Layer(e))}clearLayers(){this.getLayer(s.LayerId.player).clear(),this.getLayer(s.LayerId.fork).clear(),this.getLayer(s.LayerId.crate).clear(),this.getLayer(s.LayerId.target).clear(),this.getLayer(s.LayerId.wall).clear(),this.getLayer(s.LayerId.crack).clear()}clearMovable(){this.getLayer(s.LayerId.player).clear(),this.getLayer(s.LayerId.fork).clear(),this.getLayer(s.LayerId.crate).clear(),this.getLayer(s.LayerId.crack).clear()}getLayer(e){return this.layers[e.valueOf()]}visitLayer(e,t){let o=this.layers[e.valueOf()];o&&t(o)}getSprite(e,t,...o){if(e<0||e>=a.W)return null;if(t<0||t>=a.H)return null;for(let r of o){let o=this.layers[r];if(o){let r=o.get(e,t);if(r)return r}}return null}isSprite(e,t,o,...r){let s=this.getSprite(t,o,...r);return!!s&&s.asset===e}draw(){let e=this.canvas,t=this.context;t.clearRect(0,0,e.width,e.height),t.strokeStyle="gray",t.strokeRect(0,0,e.width,e.height);for(let o of this.layers)o&&o.draw(e,t)}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Layer=void 0;const r=o(9),s=o(1),a=o(2);t.Layer=class{constructor(e){this.id=e,this.cells=[];for(let e=0;e<s.W;e++){this.cells[e]=[];for(let t=0;t<s.H;t++)this.cells[e][t]=null}this.set=new Set}draw(e,t){for(let e of this.set){let o=a.ImageAssets.get(e.asset);t.globalAlpha=e.alpha,t.drawImage(o,e.x*s.TILE_SIZE,e.y*s.TILE_SIZE,s.TILE_SIZE,s.TILE_SIZE)}}createSpriteWithData(e){return this.createSprite(e.x,e.y,e.asset)}createSprite(e,t,o){this.get(e,t)&&console.log("new sprite target is not empty!");let s=new r.Sprite(o,this);return s.x=e,s.y=t,this.set.add(s),this.cells[e][t]=s,s}deleteSprite(e){this.set.has(e)?(this.set.delete(e),this.cells[e.x][e.y]=null):console.log("sprite is not on layer")}get(e,t){return e<0||e>=s.W||t<0||t>=s.H?null:this.cells[e][t]}is(e,t,o){let r=this.get(e,t);return!r&&!o||r.asset===o}move(e,t,o){if(t<0||t>=s.W)return null;if(o<0||o>=s.H)return null;if(!this.set.has(e))return console.log("sprite is not on this layer!"),!1;return this.get(t,o)?(console.log("move target is not empty!"),!1):(this.cells[e.x][e.y]=null,this.cells[t][o]=e,e.x=t,e.y=o,!0)}clear(){let e=Array.from(this.set);for(let t of e)this.deleteSprite(t)}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Sprite=t.SpriteData=void 0;class r{clone(){let e=new r;return e.x=this.x,e.y=this.y,e.asset=this.asset,e}}t.SpriteData=r;t.Sprite=class extends r{constructor(e,t){super(),this.alpha=1,this.asset=e,this.layer=t}move(e,t){this.layer.move(this,e,t)}toData(){let e=new r;return e.x=this.x,e.y=this.y,e.asset=this.asset,e}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Gamelogic=t.GameStatus=void 0;const r=o(0),s=o(3),a=o(1),i=o(4),l=o(11);class n{constructor(e){this.time=0,this.done=!1,this.soundPlayed=!1,this.player=null,this.forks=[],this.crateWood=[],this.crateMetal=[],this.targetWood=[],this.targetMetal=[],this.targetPlayer=[],this.cracks=[],this.history=new l.History,this.forkStatus="",this.joined=new Set,this.index=e}fromHistoryNode(e,t,o){this.time=e.time,this.forkStatus=e.forkStatus,this.joined=new Set(e.joined),t.clearMovable(),this.player=t.getLayer(r.LayerId.player).createSpriteWithData(e.player),o.isJoin()?this.player.asset=r.PLAYER_JOIN_MAPPING.get(this.player.asset):o.isFork()&&(this.player.asset=r.PLAYER_FORK_MAPPING.get(this.player.asset)),this.cracks=e.cracks.map(e=>t.getLayer(r.LayerId.crack).createSpriteWithData(e)),this.crateWood=e.crateWood.map(e=>t.getLayer(r.LayerId.crate).createSpriteWithData(e)),this.crateMetal=e.crateMetal.map(e=>t.getLayer(r.LayerId.crate).createSpriteWithData(e));let s=this.history.getNodesByTime(e.time);this.forks=s.filter(t=>t!==e&&!this.joined.has(t.forkStatus)).map(e=>({node:e,sprite:t.getLayer(r.LayerId.fork).createSpriteWithData(e.parent.player)}))}toHistoryNode(e){let t=new l.HistoryNode;return t.time=this.time,t.forkStatus=this.forkStatus,t.action=e,t.player=this.player.toData(),t.cracks=this.cracks.map(e=>e.toData()),t.crateWood=this.crateWood.map(e=>e.toData()),t.crateMetal=this.crateMetal.map(e=>e.toData()),t.joined=new Set(this.joined),t}}t.GameStatus=n;let w=null;t.Gamelogic=class{constructor(e){this.map=e}hasNextLevel(){if(this.level){let e=this.level.index+1;if(s.levels[e])return e}return-1}load(e){document.getElementById("alldone").style.display="none",document.getElementById("timehint").style.display="none",document.getElementById("joinhint").style.display="none";let t=s.levels[e];this.level=new n(e),t.map.length!==a.W*a.H&&console.log("map size doesn't match!"),document.getElementById("titlehint").style.opacity="1.0",document.getElementById("title").innerHTML=t.name,w&&clearTimeout(w),w=setTimeout(()=>document.getElementById("titlehint").style.opacity="0.0",2e3),this.map.clearLayers();for(let e=0;e<a.H;e++)for(let o=0;o<a.W;o++){let i=o+e*a.W,l=t.map[i],n=s.CELL_LAYER_MAPPING[l],w=s.CELL_IMAGE_MAPPING[l];if(n&&w){let t=this.map.getLayer(n).createSprite(o,e,w);switch(w){case r.ImageAsset.player_d:this.level.player=t;break;case r.ImageAsset.crate_wood:this.level.crateWood.push(t);break;case r.ImageAsset.crate_metal:this.level.crateMetal.push(t);break;case r.ImageAsset.target_wood_1:this.level.targetWood.push(t);break;case r.ImageAsset.target_metal_1:this.level.targetMetal.push(t);break;case r.ImageAsset.target_player_1:this.level.targetPlayer.push(t);break;case r.ImageAsset.crack_1:this.level.cracks.push(t)}}}this.level.history.init(this.level.toHistoryNode(null)),this.check(),this.map.draw(),this.updateUi()}updateUi(){document.getElementById("currentlevel").innerHTML=s.levels[this.level.index].name;let e=s.levels[this.level.index].maxtime,t=s.levels[this.level.index].goldtime,o=this.level.time,r="";o>e&&(r=" style='color:red;'"),o<=t&&(r=" style='color:#aa6c39;'"),document.getElementById("maxtime").innerHTML=`Turns: <span${r}>${o}</span> / ${e}`;this.level.forkStatus;let a="",i="";this.isFork()&&(a="forked",i=" style='color:red;'"),this.isJoin()&&(a="join",i=" style='color:red;'"),this.level.forkStatus.length&&this.isJoinedTogether()&&(a="joined together!",i=" style='color:green;'"),document.getElementById("joinstatus").innerHTML=`<span${i}>${a}</span>`}update(e){if(!this.level.done){switch(e){case r.Action.up:this.tryMove(0,-1,this.level.player),this.level.player.asset=r.ImageAsset.player_u,this.saveMove(e);break;case r.Action.down:this.tryMove(0,1,this.level.player),this.level.player.asset=r.ImageAsset.player_d,this.saveMove(e);break;case r.Action.left:this.tryMove(-1,0,this.level.player),this.level.player.asset=r.ImageAsset.player_l,this.saveMove(e);break;case r.Action.right:this.tryMove(1,0,this.level.player),this.level.player.asset=r.ImageAsset.player_r,this.saveMove(e);break;case r.Action.idle:this.saveMove(e);break;case r.Action.undo:this.undo();break;case r.Action.redo:this.redo();break;case r.Action.fork:this.level.forks.length||this.fork();break;case r.Action.join:this.join();break;case r.Action.restart:this.load(this.level.index)}this.updateUi(),this.map.draw()}}hasFork(){return this.level.forks.length>0}isJoin(e=this.level.forkStatus){let t=e;return""!==t&&"n"===t.charAt(t.length-1)&&this.hasFork()}isFork(e=this.level.forkStatus){let t=e;return""!==t&&"f"===t.charAt(t.length-1)}isJoinedTogether(e=this.level.forkStatus){let t=e;return""===t||"n"===t.charAt(t.length-1)&&!this.hasFork()}tryMove(e,t,o){let s=o.x,a=o.y,l=s+e,n=a+t;if(this.map.getSprite(l,n,r.LayerId.bg)&&!this.map.getSprite(l,n,r.LayerId.wall))if(this.isPlayerOk(l,n))o.move(l,n);else{let w=this.map.getSprite(l,n,r.LayerId.crate);if(w){let c=s+2*e,d=a+2*t;this.isCrateOk(c,d)&&(o.move(l,n),w.move(c,d),i.SoundAssets.play(r.SoundAsset.move))}}}isPlayerOk(e,t){return this.map.getSprite(e,t,r.LayerId.bg)&&!this.map.getSprite(e,t,r.LayerId.wall,r.LayerId.crate)&&!this.map.isSprite(r.ImageAsset.crack_3,e,t,r.LayerId.crack)}isCrateOk(e,t){return this.map.getSprite(e,t,r.LayerId.bg)&&!this.map.getSprite(e,t,r.LayerId.wall,r.LayerId.player,r.LayerId.crate,r.LayerId.crack)}saveMove(e){this.level.time+=1,this.tick();let t=this.level.toHistoryNode(e);this.level.history.writeNext(t),this.redo()}applyHistoryNode(e){this.level.fromHistoryNode(e,this.map,this),this.forksMove(),this.tick(),this.check(),console.log("time",this.level.time,"forkStatus",this.level.forkStatus)}undo(){this.level.history.undo(e=>{this.applyHistoryNode(e)})}redo(){this.level.history.redo(e=>{this.applyHistoryNode(e)})}fork(){this.level.history.forkNext(),i.SoundAssets.play(r.SoundAsset.fork),this.redo()}join(){this.level.history.backToForkNext(e=>{i.SoundAssets.play(r.SoundAsset.join),this.applyHistoryNode(e)})}tick(){for(let e of this.level.cracks)switch(e.asset){case r.ImageAsset.crack_1:this.map.getSprite(e.x,e.y,r.LayerId.player,r.LayerId.fork)&&(e.asset=r.ImageAsset.crack_2);break;case r.ImageAsset.crack_2:this.map.getSprite(e.x,e.y,r.LayerId.player,r.LayerId.fork)||(e.asset=r.ImageAsset.crack_3)}let e=this.map.getSprite(this.level.player.x,this.level.player.y,r.LayerId.fork);if(e){let t=this.level.forks.find(t=>t.sprite===e);!t.node.next&&this.isJoin()&&(this.level.joined.add(t.node.forkStatus),i.SoundAssets.play(r.SoundAsset.join),this.level.forks=this.level.forks.filter(t=>t.sprite!==e),this.map.getLayer(r.LayerId.fork).deleteSprite(e),this.isJoinedTogether()&&(this.level.player.asset=r.FORKJOIN_PLAYER_MAPPING.get(this.level.player.asset)))}}forksMove(){this.level.forks.forEach(e=>{switch(e.sprite.alpha=!e.node.next&&this.isJoin()?1:.5,e.sprite.asset=this.isJoin(e.node.forkStatus)?r.PLAYER_JOIN_MAPPING.get(e.sprite.asset):r.PLAYER_FORK_MAPPING.get(e.sprite.asset),e.node.action){case r.Action.up:this.tryMove(0,-1,e.sprite),e.sprite.asset=r.ImageAsset.fork_u;break;case r.Action.down:this.tryMove(0,1,e.sprite),e.sprite.asset=r.ImageAsset.fork_d;break;case r.Action.left:this.tryMove(-1,0,e.sprite),e.sprite.asset=r.ImageAsset.fork_l;break;case r.Action.right:this.tryMove(1,0,e.sprite),e.sprite.asset=r.ImageAsset.fork_r}e.node.player.x=e.sprite.x,e.node.player.y=e.sprite.y})}check(){document.getElementById("timehint").style.display="none",document.getElementById("joinhint").style.display="none";let e=this.checkTarget(this.level.targetMetal,r.ImageAsset.crate_metal,r.LayerId.crate,r.ImageAsset.target_metal_1,r.ImageAsset.target_metal_2),t=this.checkTarget(this.level.targetWood,r.ImageAsset.crate_wood,r.LayerId.crate,r.ImageAsset.target_wood_1,r.ImageAsset.target_wood_2),o=this.checkTarget(this.level.targetPlayer,null,r.LayerId.player,r.ImageAsset.target_player_1,r.ImageAsset.target_player_2),a=t&&e&&o,l=s.levels[this.level.index].maxtime,n=s.levels[this.level.index].goldtime,w=this.level.time;if(a&&this.level.forks.length&&(document.getElementById("joinhint").style.display="block",a=!1),a&&w>l&&(document.getElementById("timehint").style.display="block",a=!1),this.level.done=this.level.done||a,a&&!this.level.soundPlayed){if(w<=n){document.getElementById("load"+this.level.index).style.background="gold"}this.level.soundPlayed=!0,i.SoundAssets.play(r.SoundAsset.done)}return a}checkTarget(e,t,o,r,s){let a=!0;for(let i of e){let e=this.map.getSprite(i.x,i.y,o),l=e&&(!t||e.asset===t);a=a&&l,i.asset=l?s:r}return a}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HistoryNode=t.History=void 0;const r=o(0);t.History=class{init(e){this.current=e,this.root=e,e.parent=null,e.forkStatus="",this.forkStatus=""}getNodesByTime(e){return this.visit(this.root,t=>t.time===e||t.time<e&&!t.next,[])}getFirst(e){let t=this.visit(this.root,t=>t.forkStatus===e,[]);return t.length?t[0]:null}visit(e,t,o){return t(e)&&o.push(e),e.next&&this.visit(e.next,t,o),e.fork&&this.visit(e.fork,t,o),o}writeNext(e){this.current.next=e,e.parent=this.current,this.forkStatus=e.forkStatus}forkNext(){let e=this.current.cloneData(r.Action.fork),t=this.current.cloneData(r.Action.fork);e.time+=1,e.forkStatus+="n",t.time+=1,t.forkStatus+="f",this.current.next=e,this.current.fork=t,e.parent=this.current,t.parent=this.current,this.forkStatus=t.forkStatus}static findParent(e,t){for(;!t(e)&&e.parent;)e=e.parent;return t(e)?e:null}backToForkNext(e){let t=this.current.forkStatus;for(;t.length>0&&"n"===t.charAt(t.length-1);)t=t.substring(0,t.length-1);if(0===t.length)return void console.log("no valid parent");let o=t.substring(0,t.length-1)+"n",r=this.getFirst(o);console.log(`look for status: ${this.current.forkStatus}=>${o}, result:`,r),r&&(this.current=r,this.forkStatus=this.current.forkStatus,e(this.current))}undo(e){this.current.parent&&(this.current=this.current.parent,e(this.current))}redo(e){return this.current.fork&&this.forkStatus.startsWith(this.current.fork.forkStatus)?(this.current=this.current.fork,void e(this.current)):this.current.next&&this.forkStatus.startsWith(this.current.next.forkStatus)?(this.current=this.current.next,void e(this.current)):void console.log("no redo!")}};class s{constructor(){this.joined=new Set}cloneData(e){let t=new s;return t.time=this.time,t.forkStatus=this.forkStatus,t.action=e,t.player=this.player.clone(),t.cracks=this.cracks.map(e=>e.clone()),t.crateWood=this.crateWood.map(e=>e.clone()),t.crateMetal=this.crateMetal.map(e=>e.clone()),t.joined=new Set(this.joined),t}}t.HistoryNode=s}]);