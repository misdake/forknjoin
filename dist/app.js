!function(e){var t={};function r(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(s,a,function(t){return e[t]}.bind(null,a));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=5)}([function(e,t,r){"use strict";var s;Object.defineProperty(t,"__esModule",{value:!0}),t.LayerId=t.Action=t.SoundAsset=t.FORKJOIN_PLAYER_MAPPING=t.PLAYER_FORK_MAPPING=t.PLAYER_JOIN_MAPPING=t.ImageAsset=void 0,function(e){e.placeholder="placeholder.png",e.player_u="player_u.png",e.player_d="player_d.png",e.player_l="player_l.png",e.player_r="player_r.png",e.fork_u="fork_u.png",e.fork_d="fork_d.png",e.fork_l="fork_l.png",e.fork_r="fork_r.png",e.join_u="join_u.png",e.join_d="join_d.png",e.join_l="join_l.png",e.join_r="join_r.png",e.crack_1="crack_1.png",e.crack_2="crack_2.png",e.crack_3="crack_3.png",e.crate_wood="crate_wood.png",e.crate_metal="crate_metal.png",e.target_wood_1="target_wood_1.png",e.target_wood_2="target_wood_2.png",e.target_metal_1="target_metal_1.png",e.target_metal_2="target_metal_2.png",e.target_player_1="target_player_1.png",e.target_player_2="target_player_2.png",e.wall="wall.png",e.bg1="bg1.png",e.bg2="bg2.png",e.bg3="bg3.png",e.bg4="bg4.png"}(s=t.ImageAsset||(t.ImageAsset={})),t.PLAYER_JOIN_MAPPING=new Map([[s.fork_u,s.join_u],[s.fork_d,s.join_d],[s.fork_l,s.join_l],[s.fork_r,s.join_r],[s.join_u,s.join_u],[s.join_d,s.join_d],[s.join_l,s.join_l],[s.join_r,s.join_r],[s.player_u,s.join_u],[s.player_d,s.join_d],[s.player_l,s.join_l],[s.player_r,s.join_r]]),t.PLAYER_FORK_MAPPING=new Map([[s.fork_u,s.fork_u],[s.fork_d,s.fork_d],[s.fork_l,s.fork_l],[s.fork_r,s.fork_r],[s.join_u,s.fork_u],[s.join_d,s.fork_d],[s.join_l,s.fork_l],[s.join_r,s.fork_r],[s.player_u,s.fork_u],[s.player_d,s.fork_d],[s.player_l,s.fork_l],[s.player_r,s.fork_r]]),t.FORKJOIN_PLAYER_MAPPING=new Map([[s.fork_u,s.player_u],[s.fork_d,s.player_d],[s.fork_l,s.player_l],[s.fork_r,s.player_r],[s.join_u,s.player_u],[s.join_d,s.player_d],[s.join_l,s.player_l],[s.join_r,s.player_r],[s.player_u,s.player_u],[s.player_d,s.player_d],[s.player_l,s.player_l],[s.player_r,s.player_r]]),function(e){e.fork="fork.wav",e.join="join.wav",e.done="done.wav",e.move="move.wav"}(t.SoundAsset||(t.SoundAsset={})),function(e){e[e.up=1]="up",e[e.down=2]="down",e[e.left=3]="left",e[e.right=4]="right",e[e.idle=5]="idle",e[e.undo=6]="undo",e[e.redo=7]="redo",e[e.fork=10]="fork",e[e.join=11]="join",e[e.restart=20]="restart"}(t.Action||(t.Action={})),function(e){e[e.bg=1]="bg",e[e.crack=2]="crack",e[e.crate=3]="crate",e[e.target=4]="target",e[e.fork=5]="fork",e[e.player=6]="player",e[e.wall=7]="wall"}(t.LayerId||(t.LayerId={}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.H=t.W=t.TILE_SIZE=void 0,t.TILE_SIZE=64,t.W=9,t.H=9},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ImageAssets=void 0;const s=r(0);class a{static init(){let e=Object.values(s.ImageAsset);return Promise.all(e.map(e=>(console.log("loaded image",e),new Promise(t=>{let r=new Image;r.src="assets/"+e,a.images.set(e,r),r.onload=()=>{t()},r.onerror=()=>{console.log("image onerror, use fallback: ",e),r.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z/C/HgAGgwJ/lK3Q6wAAAABJRU5ErkJggg=="}}))))}static get(e){return a.images.get(e.valueOf())}}t.ImageAssets=a,a.images=new Map},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.startLevel=t.ALL_CELL_TYPES=t.CELL_LAYER_MAPPING=t.CELL_IMAGE_MAPPING=t.o=t.w=t.c=t.Z=t.Y=t.X=t.V=t.U=t.P=t.levels=void 0;const s=r(0);t.levels=[],t.P=1,t.U=2,t.V=3,t.X=4,t.Y=5,t.Z=6,t.c=7,t.w=8,t.o=9,t.CELL_IMAGE_MAPPING=[],t.CELL_IMAGE_MAPPING[t.P]=s.ImageAsset.player_d,t.CELL_IMAGE_MAPPING[t.U]=s.ImageAsset.crate_wood,t.CELL_IMAGE_MAPPING[t.V]=s.ImageAsset.crate_metal,t.CELL_IMAGE_MAPPING[t.X]=s.ImageAsset.target_wood_1,t.CELL_IMAGE_MAPPING[t.Y]=s.ImageAsset.target_metal_1,t.CELL_IMAGE_MAPPING[t.Z]=s.ImageAsset.target_player_1,t.CELL_IMAGE_MAPPING[t.c]=s.ImageAsset.crack_1,t.CELL_IMAGE_MAPPING[t.w]=s.ImageAsset.wall,t.CELL_LAYER_MAPPING=[],t.CELL_LAYER_MAPPING[t.P]=s.LayerId.player,t.CELL_LAYER_MAPPING[t.U]=s.LayerId.crate,t.CELL_LAYER_MAPPING[t.V]=s.LayerId.crate,t.CELL_LAYER_MAPPING[t.X]=s.LayerId.target,t.CELL_LAYER_MAPPING[t.Y]=s.LayerId.target,t.CELL_LAYER_MAPPING[t.Z]=s.LayerId.target,t.CELL_LAYER_MAPPING[t.c]=s.LayerId.crack,t.CELL_LAYER_MAPPING[t.w]=s.LayerId.wall,t.ALL_CELL_TYPES=[t.P,t.U,t.V,t.X,t.Y,t.o,t.w],t.levels[0]={name:"Sokoban",maxtime:20,goldtime:13,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.X,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.U,t.w,t.w,t.w,t.w,t.P,t.o,t.o,t.o,t.o,t.o,t.o,t.o,t.Z,t.w,t.w,t.w,t.w,t.V,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.Y,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.levels[1]={name:"Wood and Metal",maxtime:30,goldtime:17,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.o,t.o,t.o,t.o,t.o,t.o,t.w,t.w,t.o,t.o,t.o,t.o,t.o,t.o,t.o,t.w,t.w,t.o,t.o,t.U,t.o,t.Y,t.o,t.o,t.w,t.P,t.c,t.o,t.o,t.o,t.o,t.o,t.c,t.Z,t.w,t.o,t.o,t.V,t.o,t.X,t.o,t.o,t.w,t.w,t.o,t.o,t.o,t.o,t.o,t.o,t.o,t.w,t.w,t.o,t.o,t.o,t.o,t.o,t.o,t.o,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.levels[2]={name:"K to Fork<br>Then<br>J to Join",maxtime:30,goldtime:15,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.o,t.o,t.o,t.U,t.o,t.X,t.w,t.w,t.c,t.w,t.w,t.w,t.o,t.w,t.w,t.w,t.P,t.o,t.w,t.w,t.w,t.o,t.o,t.o,t.Z,t.w,t.c,t.w,t.w,t.w,t.o,t.w,t.w,t.w,t.w,t.o,t.o,t.o,t.o,t.V,t.o,t.Y,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.levels[3]={name:"Help each other",maxtime:25,goldtime:17,map:[t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.o,t.o,t.o,t.c,t.o,t.o,t.o,t.w,t.w,t.o,t.w,t.w,t.U,t.w,t.w,t.w,t.w,t.P,t.o,t.w,t.w,t.o,t.w,t.o,t.o,t.Z,t.w,t.o,t.w,t.w,t.o,t.w,t.o,t.o,t.w,t.w,t.o,t.o,t.o,t.o,t.o,t.o,t.X,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w,t.w]},t.startLevel=0},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SoundAssets=void 0;const s=r(0);class a{static init(){window.play1=()=>a.play(s.SoundAsset.done),window.play2=()=>a.play(s.SoundAsset.fork),window.play3=()=>a.play(s.SoundAsset.join);let e=Object.values(s.SoundAsset);return Promise.all(e.map(e=>(console.log("loaded sound",e),new Promise(t=>{let r=new XMLHttpRequest;r.open("GET","assets/"+e,!0),r.responseType="arraybuffer",r.onload=function(){a.context.decodeAudioData(r.response).then(r=>{a.sounds.set(e,r),t()}).catch(()=>{t()})},r.send()}))))}static play(e){console.log(e);let t=a.sounds.get(e.valueOf());if(t){let e=a.context.createBufferSource();e.buffer=t,e.connect(a.context.destination),e.start()}}}t.SoundAssets=a,a.context=new AudioContext,a.sounds=new Map},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=r(2),a=r(6),o=r(1),i=r(0),l=r(4);let n=document.getElementById("container"),c=document.getElementById("canvas"),h=c.getContext("2d"),d=document.getElementsByClassName("hint"),u=o.TILE_SIZE*o.W,y=o.TILE_SIZE*o.H;c.width=u,c.height=y,c.style.width=u+"px",c.style.height=y+"px";for(let e of d){let t=e;t.style.width=u+"px",t.style.height=y+"px"}n.style.width=u+150+"px",n.style.height=y+"px",h.clearRect(0,0,u,y),h.strokeStyle="gray",h.strokeRect(0,0,u,y),async function(){await s.ImageAssets.init(),await l.SoundAssets.init();let e=new a.Game(c,h);window.onkeypress=t=>{let r=null;switch(t.key){case"w":r=i.Action.up;break;case"a":r=i.Action.left;break;case"s":r=i.Action.down;break;case"d":r=i.Action.right;break;case" ":r=i.Action.idle;break;case"j":r=i.Action.join;break;case"k":r=i.Action.fork;break;case"z":r=i.Action.undo;break;case"x":r=i.Action.redo;break;case"r":r=i.Action.restart}r&&e.update(r)}}()},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Game=void 0;const s=r(7),a=r(1),o=r(10),i=r(0),l=r(3);t.Game=class{constructor(e,t){this.canvas=e,this.context=t,this.map=new s.GameMap(e,t),this.init(),this.gamelogic=new o.Gamelogic(this.map),this.gamelogic.load(l.startLevel)}init(){this.map.visitLayer(i.LayerId.bg,e=>{for(let t=0;t<a.W;t++)for(let r=0;r<a.H;r++){let s=Math.floor(4*Math.random())+1,a=i.ImageAsset.placeholder;switch(s){case 1:a=i.ImageAsset.bg1;break;case 2:a=i.ImageAsset.bg2;break;case 3:a=i.ImageAsset.bg3;break;case 4:a=i.ImageAsset.bg4}e.createSprite(t,r,a)}});let e="";for(let t=0;t<l.levels.length;t++)e+=`<button id="load${t}" style="font-size: 16px;">${t+1}</button>\n`;document.getElementById("levels").innerHTML=e;for(let e=0;e<l.levels.length;e++){let t=document.getElementById("load"+e);t.onclick=()=>{this.gamelogic.load(e),t.blur()}}}update(e){if(this.gamelogic.update(e),this.gamelogic.check()){console.log("levelDone");let e=this.gamelogic.hasNextLevel();e>0?setTimeout(()=>{this.gamelogic.load(e)},500):(console.log("all done!"),document.getElementById("alldone").style.display="block")}}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameMap=void 0;const s=r(8),a=r(0),o=r(1);t.GameMap=class{constructor(e,t){this.canvas=e,this.context=t;let r=Object.values(a.LayerId);this.layers=[];for(let e of r)"number"==typeof e&&(this.layers[e]=new s.Layer(e))}clearLayers(){this.getLayer(a.LayerId.player).clear(),this.getLayer(a.LayerId.fork).clear(),this.getLayer(a.LayerId.crate).clear(),this.getLayer(a.LayerId.target).clear(),this.getLayer(a.LayerId.wall).clear(),this.getLayer(a.LayerId.crack).clear()}clearMovable(){this.getLayer(a.LayerId.player).clear(),this.getLayer(a.LayerId.fork).clear(),this.getLayer(a.LayerId.crate).clear(),this.getLayer(a.LayerId.crack).clear()}getLayer(e){return this.layers[e.valueOf()]}visitLayer(e,t){let r=this.layers[e.valueOf()];r&&t(r)}getSprite(e,t,...r){if(e<0||e>=o.W)return null;if(t<0||t>=o.H)return null;for(let s of r){let r=this.layers[s];if(r){let s=r.get(e,t);if(s)return s}}return null}isSprite(e,t,r,...s){let a=this.getSprite(t,r,...s);return!!a&&a.asset===e}draw(){let e=this.canvas,t=this.context;t.clearRect(0,0,e.width,e.height),t.strokeStyle="gray",t.strokeRect(0,0,e.width,e.height);for(let r of this.layers)r&&r.draw(e,t)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Layer=void 0;const s=r(9),a=r(1),o=r(2);t.Layer=class{constructor(e){this.id=e,this.cells=[];for(let e=0;e<a.W;e++){this.cells[e]=[];for(let t=0;t<a.H;t++)this.cells[e][t]=null}this.set=new Set}draw(e,t){for(let e of this.set){let r=o.ImageAssets.get(e.asset);t.globalAlpha=e.alpha,t.drawImage(r,e.x*a.TILE_SIZE,e.y*a.TILE_SIZE,a.TILE_SIZE,a.TILE_SIZE)}}createSpriteWithData(e){return this.createSprite(e.x,e.y,e.asset)}createSprite(e,t,r){this.get(e,t)&&console.log("new sprite target is not empty!");let a=new s.Sprite(r,this);return a.x=e,a.y=t,this.set.add(a),this.cells[e][t]=a,a}deleteSprite(e){this.set.has(e)?(this.set.delete(e),this.cells[e.x][e.y]=null):console.log("sprite is not on layer")}get(e,t){return e<0||e>=a.W||t<0||t>=a.H?null:this.cells[e][t]}is(e,t,r){let s=this.get(e,t);return!s&&!r||s.asset===r}move(e,t,r){if(t<0||t>=a.W)return null;if(r<0||r>=a.H)return null;if(!this.set.has(e))return console.log("sprite is not on this layer!"),!1;return this.get(t,r)?(console.log("move target is not empty!"),!1):(this.cells[e.x][e.y]=null,this.cells[t][r]=e,e.x=t,e.y=r,!0)}clear(){let e=Array.from(this.set);for(let t of e)this.deleteSprite(t)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Sprite=t.SpriteData=void 0;class s{clone(){let e=new s;return e.x=this.x,e.y=this.y,e.asset=this.asset,e}}t.SpriteData=s;t.Sprite=class extends s{constructor(e,t){super(),this.alpha=1,this.asset=e,this.layer=t}move(e,t){this.layer.move(this,e,t)}toData(){let e=new s;return e.x=this.x,e.y=this.y,e.asset=this.asset,e}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Gamelogic=t.GameStatus=void 0;const s=r(0),a=r(3),o=r(1),i=r(4),l=r(11);class n{constructor(e){this.time=0,this.done=!1,this.soundPlayed=!1,this.player=null,this.forks=[],this.crateWood=[],this.crateMetal=[],this.targetWood=[],this.targetMetal=[],this.targetPlayer=[],this.cracks=[],this.history=new l.History,this.forkStatus="",this.joined=new Set,this.index=e}fromHistoryNode(e,t,r){this.time=e.time,this.forkStatus=e.forkStatus,t.clearMovable(),this.player=t.getLayer(s.LayerId.player).createSpriteWithData(e.player),r.isJoin()?this.player.asset=s.PLAYER_JOIN_MAPPING.get(this.player.asset):r.isFork()&&(this.player.asset=s.PLAYER_FORK_MAPPING.get(this.player.asset)),this.cracks=e.cracks.map(e=>t.getLayer(s.LayerId.crack).createSpriteWithData(e)),this.crateWood=e.crateWood.map(e=>t.getLayer(s.LayerId.crate).createSpriteWithData(e)),this.crateMetal=e.crateMetal.map(e=>t.getLayer(s.LayerId.crate).createSpriteWithData(e));let a=this.history.getNodesByTime(e.time);this.forks=a.filter(t=>t!==e&&!this.joined.has(t.forkStatus)).map(e=>({node:e,sprite:t.getLayer(s.LayerId.fork).createSpriteWithData(e.parent.player)}))}toHistoryNode(e){let t=new l.HistoryNode;return t.time=this.time,t.forkStatus=this.forkStatus,t.action=e,t.player=this.player.toData(),t.cracks=this.cracks.map(e=>e.toData()),t.crateWood=this.crateWood.map(e=>e.toData()),t.crateMetal=this.crateMetal.map(e=>e.toData()),t}}t.GameStatus=n;let c=null;t.Gamelogic=class{constructor(e){this.map=e}hasNextLevel(){if(this.level){let e=this.level.index+1;if(a.levels[e])return e}return-1}load(e){document.getElementById("alldone").style.display="none",document.getElementById("timehint").style.display="none",document.getElementById("joinhint").style.display="none";let t=a.levels[e];this.level=new n(e),t.map.length!==o.W*o.H&&console.log("map size doesn't match!"),document.getElementById("titlehint").style.opacity="1.0",document.getElementById("title").innerHTML=t.name,c&&clearTimeout(c),c=setTimeout(()=>document.getElementById("titlehint").style.opacity="0.0",2e3),this.map.clearLayers();for(let e=0;e<o.H;e++)for(let r=0;r<o.W;r++){let i=r+e*o.W,l=t.map[i],n=a.CELL_LAYER_MAPPING[l],c=a.CELL_IMAGE_MAPPING[l];if(n&&c){let t=this.map.getLayer(n).createSprite(r,e,c);switch(c){case s.ImageAsset.player_d:this.level.player=t;break;case s.ImageAsset.crate_wood:this.level.crateWood.push(t);break;case s.ImageAsset.crate_metal:this.level.crateMetal.push(t);break;case s.ImageAsset.target_wood_1:this.level.targetWood.push(t);break;case s.ImageAsset.target_metal_1:this.level.targetMetal.push(t);break;case s.ImageAsset.target_player_1:this.level.targetPlayer.push(t);break;case s.ImageAsset.crack_1:this.level.cracks.push(t)}}}this.level.history.init(this.level.toHistoryNode(null)),this.check(),this.map.draw(),this.updateUi()}updateUi(){document.getElementById("currentlevel").innerHTML=a.levels[this.level.index].name;let e=a.levels[this.level.index].maxtime,t=a.levels[this.level.index].goldtime,r=this.level.time,s="";r>e&&(s=" style='color:red;'"),r<=t&&(s=" style='color:#aa6c39;'"),document.getElementById("maxtime").innerHTML=`Turns: <span${s}>${r}</span> / ${e} max`;this.level.forkStatus;let o="",i="";this.isFork()&&(o="forked",i=" style='color:red;'"),this.isJoin()&&(o="join",i=" style='color:red;'"),this.level.forkStatus.length&&this.isJoinedTogether()&&(o="joined together!",i=" style='color:green;'"),document.getElementById("joinstatus").innerHTML=`<span${i}>${o}</span>`}update(e){if(!this.level.done){switch(e){case s.Action.up:this.tryMove(0,-1,this.level.player),this.level.player.asset=s.ImageAsset.player_u,this.saveMove(e);break;case s.Action.down:this.tryMove(0,1,this.level.player),this.level.player.asset=s.ImageAsset.player_d,this.saveMove(e);break;case s.Action.left:this.tryMove(-1,0,this.level.player),this.level.player.asset=s.ImageAsset.player_l,this.saveMove(e);break;case s.Action.right:this.tryMove(1,0,this.level.player),this.level.player.asset=s.ImageAsset.player_r,this.saveMove(e);break;case s.Action.idle:this.saveMove(e);break;case s.Action.undo:this.undo();break;case s.Action.redo:this.redo();break;case s.Action.fork:this.level.forks.length||this.fork();break;case s.Action.join:this.join();break;case s.Action.restart:this.load(this.level.index)}this.updateUi(),this.map.draw()}}hasFork(){return this.level.forks.length>0}isJoin(e=this.level.forkStatus){let t=e;return""!==t&&"n"===t.charAt(t.length-1)&&this.hasFork()}isFork(e=this.level.forkStatus){let t=e;return""!==t&&"f"===t.charAt(t.length-1)}isJoinedTogether(e=this.level.forkStatus){let t=e;return""===t||"n"===t.charAt(t.length-1)&&!this.hasFork()}tryMove(e,t,r){let a=r.x,o=r.y,l=a+e,n=o+t;if(this.map.getSprite(l,n,s.LayerId.bg)&&!this.map.getSprite(l,n,s.LayerId.wall))if(this.isPlayerOk(l,n))r.move(l,n);else{let c=this.map.getSprite(l,n,s.LayerId.crate);if(c){let h=a+2*e,d=o+2*t;this.isCrateOk(h,d)&&(r.move(l,n),c.move(h,d),i.SoundAssets.play(s.SoundAsset.move))}}}isPlayerOk(e,t){return this.map.getSprite(e,t,s.LayerId.bg)&&!this.map.getSprite(e,t,s.LayerId.wall,s.LayerId.crate)&&!this.map.isSprite(s.ImageAsset.crack_3,e,t,s.LayerId.crack)}isCrateOk(e,t){return this.map.getSprite(e,t,s.LayerId.bg)&&!this.map.getSprite(e,t,s.LayerId.wall,s.LayerId.player,s.LayerId.crate,s.LayerId.crack)}saveMove(e){this.level.time+=1,this.tick();let t=this.level.toHistoryNode(e);this.level.history.writeNext(t),this.redo()}applyHistoryNode(e){this.level.fromHistoryNode(e,this.map,this),this.forksMove(),this.tick(),this.check(),console.log("time",this.level.time,"forkStatus",this.level.forkStatus)}undo(){this.level.history.undo(e=>{this.applyHistoryNode(e)})}redo(){this.level.history.redo(e=>{this.applyHistoryNode(e)})}fork(){this.level.history.forkNext(),i.SoundAssets.play(s.SoundAsset.fork),this.redo()}join(){this.level.history.backToForkNext(e=>{i.SoundAssets.play(s.SoundAsset.join),this.applyHistoryNode(e)})}tick(){for(let e of this.level.cracks)switch(e.asset){case s.ImageAsset.crack_1:this.map.getSprite(e.x,e.y,s.LayerId.player,s.LayerId.fork)&&(e.asset=s.ImageAsset.crack_2);break;case s.ImageAsset.crack_2:this.map.getSprite(e.x,e.y,s.LayerId.player,s.LayerId.fork)||(e.asset=s.ImageAsset.crack_3)}let e=this.map.getSprite(this.level.player.x,this.level.player.y,s.LayerId.fork);if(e){let t=this.level.forks.find(t=>t.sprite===e);!t.node.next&&this.isJoin()&&(this.level.joined.add(t.node.forkStatus),i.SoundAssets.play(s.SoundAsset.join),this.level.forks=this.level.forks.filter(t=>t.sprite!==e),this.map.getLayer(s.LayerId.fork).deleteSprite(e),this.isJoinedTogether()&&(this.level.player.asset=s.FORKJOIN_PLAYER_MAPPING.get(this.level.player.asset)))}}forksMove(){this.level.forks.forEach(e=>{switch(e.sprite.alpha=!e.node.next&&this.isJoin()?1:.5,e.sprite.asset=this.isJoin(e.node.forkStatus)?s.PLAYER_JOIN_MAPPING.get(e.sprite.asset):s.PLAYER_FORK_MAPPING.get(e.sprite.asset),e.node.action){case s.Action.up:this.tryMove(0,-1,e.sprite),e.sprite.asset=s.ImageAsset.fork_u;break;case s.Action.down:this.tryMove(0,1,e.sprite),e.sprite.asset=s.ImageAsset.fork_d;break;case s.Action.left:this.tryMove(-1,0,e.sprite),e.sprite.asset=s.ImageAsset.fork_l;break;case s.Action.right:this.tryMove(1,0,e.sprite),e.sprite.asset=s.ImageAsset.fork_r}e.node.player.x=e.sprite.x,e.node.player.y=e.sprite.y})}check(){document.getElementById("timehint").style.display="none",document.getElementById("joinhint").style.display="none";let e=this.checkTarget(this.level.targetMetal,s.ImageAsset.crate_metal,s.LayerId.crate,s.ImageAsset.target_metal_1,s.ImageAsset.target_metal_2),t=this.checkTarget(this.level.targetWood,s.ImageAsset.crate_wood,s.LayerId.crate,s.ImageAsset.target_wood_1,s.ImageAsset.target_wood_2),r=this.checkTarget(this.level.targetPlayer,null,s.LayerId.player,s.ImageAsset.target_player_1,s.ImageAsset.target_player_2),o=t&&e&&r,l=a.levels[this.level.index].maxtime,n=a.levels[this.level.index].goldtime,c=this.level.time;if(o&&c>l&&(document.getElementById("timehint").style.display="block",o=!1),o&&this.level.forks.length&&(document.getElementById("joinhint").style.display="block",o=!1),this.level.done=this.level.done||o,o&&!this.level.soundPlayed){if(c<=n){document.getElementById("load"+this.level.index).style.background="gold"}this.level.soundPlayed=!0,i.SoundAssets.play(s.SoundAsset.done)}return o}checkTarget(e,t,r,s,a){let o=!0;for(let i of e){let e=this.map.getSprite(i.x,i.y,r),l=e&&(!t||e.asset===t);o=o&&l,i.asset=l?a:s}return o}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HistoryNode=t.History=void 0;const s=r(0);t.History=class{init(e){this.current=e,this.root=e,e.parent=null,e.forkStatus="",this.forkStatus=""}getNodesByTime(e){return this.visit(this.root,t=>t.time===e||t.time<e&&!t.next,[])}getFirst(e){let t=this.visit(this.root,t=>t.forkStatus===e,[]);return t.length?t[0]:null}visit(e,t,r){return t(e)&&r.push(e),e.next&&this.visit(e.next,t,r),e.fork&&this.visit(e.fork,t,r),r}writeNext(e){this.current.next=e,e.parent=this.current,this.forkStatus=e.forkStatus}forkNext(){let e=this.current.cloneData(s.Action.fork),t=this.current.cloneData(s.Action.fork);e.time+=1,e.forkStatus+="n",t.time+=1,t.forkStatus+="f",this.current.next=e,this.current.fork=t,e.parent=this.current,t.parent=this.current,this.forkStatus=t.forkStatus}static findParent(e,t){for(;!t(e)&&e.parent;)e=e.parent;return t(e)?e:null}backToForkNext(e){let t=this.current.forkStatus;for(;t.length>0&&"n"===t.charAt(t.length-1);)t=t.substring(0,t.length-1);if(0===t.length)return void console.log("no valid parent");let r=t.substring(0,t.length-1)+"n",s=this.getFirst(r);console.log(`look for status: ${this.current.forkStatus}=>${r}, result:`,s),s&&(this.current=s,this.forkStatus=this.current.forkStatus,e(this.current))}undo(e){this.current.parent&&(this.current=this.current.parent,e(this.current))}redo(e){return this.current.fork&&this.forkStatus.startsWith(this.current.fork.forkStatus)?(this.current=this.current.fork,void e(this.current)):this.current.next&&this.forkStatus.startsWith(this.current.next.forkStatus)?(this.current=this.current.next,void e(this.current)):void console.log("no redo!")}};class a{cloneData(e){let t=new a;return t.time=this.time,t.forkStatus=this.forkStatus,t.action=e,t.player=this.player.clone(),t.cracks=this.cracks.map(e=>e.clone()),t.crateWood=this.crateWood.map(e=>e.clone()),t.crateMetal=this.crateMetal.map(e=>e.clone()),t}}t.HistoryNode=a}]);